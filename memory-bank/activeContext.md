# 현재 작업 상황: Flask 웹 아키텍처 재구성 (내실 다지기)

**아카이브**: 이 파일은 현재 진행 중인 작업에만 집중합니다. 과거 기록은 [activeContext_101.md](./activeContext_101.md)에서 확인할 수 있습니다.

---

## 🎯 프로젝트 목표 및 배경

**핵심 판단**: 현재의 모놀리식 구조를 재구성하여, 향후 AI 및 양자역학 같은 복잡한 분야로 확장할 수 있는 견고한 기반을 마련하는 것이 시급합니다.

**현재 문제점**:
- 여러 Flask 앱 파일(`app.py`, `app_original.py` 등)이 루트에 혼재되어 관리 복잡성 증가.
- 비즈니스 로직과 프레젠테이션 로직이 혼재되어 유지보수 및 확장이 어려움.
- 표준화된 구조 부재로 신규 기능 추가 시 비효율 발생.

---

## 🏗️ Flask 아키텍처 재구성 진행 상황 (2025-06-17)

### 📊 현재 진행률: 약 70% 완료

**✅ 완료된 작업 (Phase A: Blueprint 통합)**:
1.  **Application Factory 패턴 구현**: `app/__init__.py`에서 `create_app()` 함수를 통해 앱 인스턴스 생성.
2.  **4개 핵심 Blueprint 분리 완료**:
    - `main_routes.py`: 기본 페이지 라우팅
    - `math_routes.py`: 수학 검증 API
    - `bagua_routes.py`: 8괘/64괘 시스템
    - `api_routes.py`: MongoDB 및 Q&A API
3.  **8개 수학 검증 모듈 클래스화**: `app/services/math_core/` 디렉토리로 분리 완료.

**🔄 부분 완료된 작업 (Phase B: Service Layer)**:
1.  **서비스 레이어 구조 생성**: `app/services/` 폴더 생성.
2.  **핵심 서비스 구현**: `mongodb.py`, `bagua_generator.py` 등 핵심 로직 분리.
3.  **라우트-서비스 연결**: `math_routes.py`에서 `math_core`의 서비스 클래스를 호출하는 구조.

---

### ⚠️ **미완성 작업 및 다음 단계 (Phase C: 구조 재정리)**

**🔸 최우선 과제**:
1.  **레거시 파일 정리**: 루트 디렉토리의 `app_*.py`, `*.web.py` 등 레거시 Flask 파일들을 `legacy/` 폴더로 이동.
2.  **템플릿 및 정적 파일 경로 확인**: `app/templates`와 `app/static` 내부 파일들이 새 구조에서 올바르게 참조되는지 검증.
3.  **설정 관리 시스템 도입**: `.env` 파일을 활용한 환경 변수 관리 및 `app/utils/config.py` 완성.

**🔸 중기 과제**:
4.  **통합 에러 처리 및 로깅**: 일관된 에러 핸들러와 로그 시스템 구축.
5.  **단위/통합 테스트**: 재구성된 아키텍처에 대한 테스트 코드 작성.

---

## 🧪 테스트 프레임워크 구축 (2025-06-17)

**목표**: `pytest`와 `Playwright`를 사용하여 애플리케이션의 안정성을 보장하는 테스트 환경을 구축합니다.

**✅ 완료된 작업**:
1.  **테스트 라이브러리 설치**: `uv`를 사용하여 `pytest`, `pytest-flask`, `pytest-playwright` 설치 완료.
2.  **테스트 구조 생성**:
    -   `tests/` 디렉토리 생성.
    -   `tests/conftest.py`: `app`과 `client` fixture 설정.
    -   `tests/test_app.py`: 기본 홈페이지 로드 단위 테스트.
    -   `tests/test_api.py`: `/math/api/verification/pi` API 엔드포인트 테스트.
    -   `tests/test_e2e.py`: Playwright를 사용한 사용자 시나리오 테스트.

**⚠️ 현재 상태 및 문제점**:
-   **성공**: 단위 테스트(`test_app.py`)와 API 테스트(`test_api.py`)는 모두 **성공적으로 통과**합니다.
-   **실패**: E2E 테스트(`test_pi_verification_flow`)가 'Pi (π) 검증' 버튼을 클릭하는 단계에서 계속 **시간 초과 오류(TimeoutError)**가 발생합니다.
-   **결정**: 여러 차례의 디버깅 시도(선택자 변경, 사용자 흐름 시뮬레이션 등)에도 불구하고 문제가 해결되지 않아, **E2E 테스트 안정화 작업은 일단 보류**하고 다른 우선순위 높은 작업을 먼저 진행하기로 결정했습니다.

**📜 앞으로의 개발 지침**:
-   **테스트 주도 개발(TDD) 원칙 적용**: 모든 신규 기능 및 버그 수정 시, 관련 `pytest` 테스트 코드를 반드시 작성하고 통과시켜야 합니다.

---

## 🌌 미래 확장 계획: 64괘 매핑 (프로젝트 2단계)

**핵심 개념**: 현재의 8괘-기초 수학 개념 매핑(1단계)이 안정화되면, 프로젝트는 8괘 두 개를 조합하여 64괘를 더 고차원적인 복합 수학 이론으로 확장하는 2단계로 진입합니다. 이 계획은 `activeContext_101.md`에 기록된 핵심 로드맵을 따릅니다.

**핵심 원리**: `8괘 (기초 개념) + 8괘 (기초 개념) → 64괘 (복합 이론)`

**대표 예시: 16번 뇌지예(雷地豫)**
- **괘 구성**: ☷(땅, 곤) + ☳(우레, 진)
- **1단계 개념 조합**: 이진법(곤) + 도함수(진)
- **2단계 복합 이론**: **이산 푸리에 변환 (DFT/FFT)**
- **의의**: 이산적 세계(디지털 신호)의 연속적 변화(주파수)를 분석하는 핵심 기술로, AI, 신호 처리 등 현대 기술의 근간을 이룹니다.

**우선순위 개발 로드맵**:

| 순위 | 괘번호 | 괘명 | 8괘 조합 | 수학 이론 |
|:----:|:------:|:----:|:----------|:-----------|
| 1위 | 16 | 뇌지예 | 이진법+도함수 | 이산 푸리에 변환 |
| 2위 | 51 | 중뢰진 | 도함수+도함수 | 2차 도함수(가속도) |
| 3위 | 52 | 중산간 | 소수론+소수론 | 소수체 이론 |
| 4위 | 3 | 수뢰둔 | 확률론+도함수 | 마르코프 체인 |
| 5위 | 58 | 중택태 | 대칭성+대칭성 | 군론(Group Theory) |

이 로드맵은 프로젝트의 최종 목표인 '동서양 지식 체계의 융합'과 'AI/물리학으로의 확장'을 위한 구체적인 청사진입니다.

---

## 🚀 즉시 실행할 다음 작업

1.  **레거시 파일 정리**: `legacy/` 폴더로 모든 구형 `app_*.py` 파일을 이동시키고, `run.py`를 통한 시스템이 정상 작동하는지 확인.
2.  **기능 테스트**: 메인 페이지, `/math/api/verification/*` 엔드포인트 등 핵심 기능들이 Blueprint 구조 하에서 정상적으로 동작하는지 전체적으로 검증.
3.  **(보류) E2E 테스트 디버깅**: `test_pi_verification_flow` 실패 원인 심층 분석.

**다음 세션 키워드**: "Flask 레거시 파일 정리" 또는 "Flask 구조 재정리 완료"
