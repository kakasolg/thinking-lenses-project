import streamlit as st
import random
import logging # ë¡œê¹… ì¶”ê°€
from mongodb import ask_hexagram # mongodb.pyì—ì„œ ask_hexagram í•¨ìˆ˜ ì„í¬íŠ¸


# ğŸ¯ 64ê´˜ ê´˜ìƒ(å¦è±¡) ë°ì´í„° ì •ì˜
# ê° ê´˜ëŠ” 6ê°œ íš¨ë¡œ êµ¬ì„±: [6íš¨, 5íš¨, 4íš¨, 3íš¨, 2íš¨, 1íš¨] (ìœ„ì—ì„œ ì•„ë˜ë¡œ)
# 1 = ì–‘íš¨(é™½çˆ»), 0 = ìŒíš¨(é™°çˆ»)
HEXAGRAM_LINES = {
    # 1-8ê´˜ (ìƒê´˜: ê±´â˜°)
    1:  [1, 1, 1, 1, 1, 1],  # ê±´(ä¹¾) â˜°â˜°
    2:  [0, 0, 0, 0, 0, 0],  # ê³¤(å¤) â˜·â˜·
    3:  [1, 0, 0, 0, 0, 1],  # ë‘”(å±¯) â˜³â˜µ
    4:  [0, 0, 1, 1, 0, 0],  # ëª½(è’™) â˜¶â˜µ
    5:  [1, 1, 1, 0, 1, 0],  # ìˆ˜(éœ€) â˜µâ˜°
    6:  [0, 1, 0, 1, 1, 1],  # ì†¡(è¨Ÿ) â˜°â˜µ
    7:  [0, 1, 0, 0, 0, 0],  # ì‚¬(å¸«) â˜·â˜µ
    8:  [0, 0, 0, 0, 1, 0],  # ë¹„(æ¯”) â˜µâ˜·
    
    # 9-16ê´˜ (ìƒê´˜: ì†â˜´)
    9:  [1, 1, 0, 1, 1, 1],  # ì†Œì¶•(å°ç•œ) â˜°â˜´
    10: [1, 1, 0, 0, 1, 1],  # ë¦¬(å±¥) â˜±â˜°
    11: [1, 1, 1, 0, 0, 0],  # íƒœ(æ³°) â˜·â˜°
    12: [0, 0, 0, 1, 1, 1],  # ë¹„(å¦) â˜°â˜·
    13: [1, 0, 1, 1, 1, 1],  # ë™ì¸(åŒäºº) â˜°â˜²
    14: [1, 1, 1, 1, 0, 1],  # ëŒ€ìœ (å¤§æœ‰) â˜²â˜°
    15: [0, 0, 1, 0, 0, 0],  # ê²¸(è¬™) â˜·â˜¶
    16: [0, 0, 0, 1, 0, 0],  # ì˜ˆ(è±«) â˜³â˜·
    
    # 17-24ê´˜ (ìƒê´˜: ë¦¬â˜²)
    17: [1, 0, 0, 1, 1, 0],  # ìˆ˜(éš¨) â˜±â˜³
    18: [0, 1, 1, 1, 1, 0],  # ê³ (è ±) â˜´â˜¶
    19: [1, 1, 0, 0, 0, 0],  # ë¦¼(è‡¨) â˜·â˜±
    20: [0, 0, 0, 0, 1, 1],  # ê´€(è§€) â˜´â˜·
    21: [1, 0, 0, 1, 0, 1],  # ì„œí•©(å™¬å—‘) â˜²â˜³
    22: [1, 0, 1, 0, 0, 1],  # ë¹„(è³) â˜¶â˜²
    23: [0, 0, 0, 0, 0, 1],  # ë°•(å‰) â˜¶â˜·
    24: [1, 0, 0, 0, 0, 0],  # ë³µ(å¾©) â˜·â˜³
    
    # 25-32ê´˜ (ìƒê´˜: ì§„â˜³)
    25: [1, 0, 0, 1, 1, 1],  # ë¬´ë§(ç„¡å¦„) â˜°â˜³
    26: [1, 1, 1, 0, 0, 1],  # ëŒ€ì¶•(å¤§ç•œ) â˜³â˜°
    27: [1, 0, 0, 0, 0, 1],  # ì´(é ¤) â˜¶â˜³
    28: [0, 1, 1, 1, 1, 0],  # ëŒ€ê³¼(å¤§é) â˜±â˜´
    29: [0, 1, 0, 0, 1, 0],  # ê°(å) â˜µâ˜µ
    30: [1, 0, 1, 1, 0, 1],  # ë¦¬(é›¢) â˜²â˜²
    
    # 31-40ê´˜ (ìƒê´˜: ê°â˜µ)
    31: [0, 0, 1, 1, 1, 0],  # ê°(å’¸) â˜±â˜¶
    32: [0, 1, 1, 1, 0, 0],  # í•­(æ†) â˜³â˜´
    33: [0, 0, 1, 1, 1, 1],  # ë‘”(é) â˜°â˜¶
    34: [1, 1, 1, 1, 0, 0],  # ëŒ€ì¥(å¤§å£¯) â˜³â˜°
    35: [0, 0, 0, 1, 0, 1],  # ì§„(æ™‹) â˜²â˜·
    36: [1, 0, 1, 0, 0, 0],  # ëª…ì´(æ˜å¤·) â˜·â˜²
    37: [1, 0, 1, 0, 1, 1],  # ê°€ì¸(å®¶äºº) â˜´â˜²
    38: [1, 1, 0, 1, 0, 1],  # ê·œ(ç½) â˜²â˜±
    39: [0, 0, 1, 0, 1, 0],  # ê±´(è¹‡) â˜µâ˜¶
    40: [0, 1, 0, 1, 0, 0],  # í•´(è§£) â˜³â˜µ
    
    # 41-48ê´˜ (ìƒê´˜: ë¡œâ˜±)
    41: [1, 1, 0, 0, 0, 1],  # ì†(æ) â˜¶â˜±
    42: [1, 0, 0, 0, 1, 1],  # ìµ(ç›Š) â˜´â˜³
    43: [1, 1, 1, 1, 1, 0],  # ê²°(å¤¬) â˜±â˜°
    44: [0, 1, 1, 1, 1, 1],  # êµ¬(å§¤) â˜°â˜´
    45: [0, 0, 0, 1, 1, 0],  # ì·¨(èƒ) â˜±â˜·
    46: [0, 1, 1, 0, 0, 0],  # ìƒ(å‡) â˜·â˜´
    47: [0, 1, 0, 1, 1, 0],  # ê³¤(å›°) â˜±â˜µ
    48: [0, 1, 1, 0, 1, 0],  # ì •(äº•) â˜µâ˜´
    
    # 49-56ê´˜ (ìƒê´˜: íƒœâ˜±)
    49: [1, 0, 1, 1, 1, 0],  # í˜(é©) â˜±â˜²
    50: [0, 1, 1, 1, 0, 1],  # ì •(é¼) â˜²â˜´
    51: [1, 0, 0, 1, 0, 0],  # ì§„(éœ‡) â˜³â˜³
    52: [0, 0, 1, 0, 0, 1],  # ê°„(è‰°) â˜¶â˜¶
    53: [0, 0, 1, 0, 1, 1],  # ì (æ¼¸) â˜´â˜¶
    54: [1, 1, 0, 1, 0, 0],  # ê·€ë©”(æ­¸å¦¹) â˜³â˜±
    55: [1, 0, 1, 1, 0, 0],  # í’(è±) â˜³â˜²
    56: [0, 0, 1, 1, 0, 1],  # ë¡œ(æ—…) â˜²â˜¶
    
    # 57-64ê´˜ (ìƒê´˜: ì†â˜´, íƒœâ˜±)
    57: [0, 1, 1, 0, 1, 1],  # ì†(å·½) â˜´â˜´
    58: [1, 1, 0, 1, 1, 0],  # íƒœ(å…‘) â˜±â˜±
    59: [0, 1, 0, 0, 1, 1],  # í™˜(æ¸™) â˜´â˜µ
    60: [1, 1, 0, 0, 1, 0],  # ì ˆ(ç¯€) â˜µâ˜±
    61: [1, 1, 0, 0, 1, 1],  # ì¤‘ë¶€(ä¸­å­š) â˜´â˜±
    62: [0, 0, 1, 1, 0, 0],  # ì†Œê³¼(å°é) â˜¶â˜³
    63: [1, 0, 1, 0, 1, 0],  # ê¸°ì œ(æ—¢æ¿Ÿ) â˜µâ˜²
    64: [0, 1, 0, 1, 0, 1],  # ë¯¸ì œ(æœªæ¿Ÿ) â˜²â˜µ
    }

# ğŸ”„ íš¨ë³€ ê³„ì‚° í•¨ìˆ˜ë“¤
def flip_line(line_value):
    """í•œ íš¨ë¥¼ ë’¤ì§‘ê¸°: ì–‘íš¨(1) â†” ìŒíš¨(0)"""
    return 1 - line_value

def calculate_target_hexagram(original_hex_num, changing_line_pos):
    """
    íš¨ë³€ì„ í†µí•œ ì§€ê´˜(ä¹‹å¦) ê³„ì‚°
    
    Args:
        original_hex_num (int): ì›ê´˜ ë²ˆí˜¸ (1-64)
        changing_line_pos (int): ë³€í•˜ëŠ” íš¨ ìœ„ì¹˜ (1-6)
    
    Returns:
        int: ì§€ê´˜(ä¹‹å¦) ë²ˆí˜¸ (1-64)
    """
    if original_hex_num not in HEXAGRAM_LINES:
        return None
        
    # ì›ê´˜ ë°”ì´ë„ˆë¦¬ ë³µì‚¬
    original_lines = HEXAGRAM_LINES[original_hex_num][:]
    
    # íš¨ ë²ˆí˜¸ë¥¼ ì¸ë±ìŠ¤ë¡œ ë³€í™˜ (1íš¨=ì¸ë±ìŠ¤ 5, 6íš¨=ì¸ë±ìŠ¤ 0)
    line_index = 6 - changing_line_pos
    
    # í•´ë‹¹ íš¨ ë’¤ì§‘ê¸°
    original_lines[line_index] = flip_line(original_lines[line_index])
    
    # ìƒˆë¡œìš´ ê´˜ ë²ˆí˜¸ ì°¾ê¸°
    for hex_num, lines in HEXAGRAM_LINES.items():
        if lines == original_lines:
            return hex_num
    
    return None  # ì—ëŸ¬ ì¼€ì´ìŠ¤

def generate_full_eff_change_map():
    """
    ì „ì²´ 384ê°€ì§€ íš¨ë³€ ì‹œë‚˜ë¦¬ì˜¤ (64ê´˜ Ã— 6íš¨) ìë™ ìƒì„±
    
    Returns:
        dict: eff_change_map êµ¬ì¡°
        {
            ê´˜ë²ˆí˜¸: {
                íš¨ë²ˆí˜¸: ì§€ê´˜ë²ˆí˜¸
            }
        }
    """
    eff_change_map = {}
    
    for hex_num in range(1, 65):  # 1-64ê´˜
        eff_change_map[hex_num] = {}
        
        for line_pos in range(1, 7):  # 1-6íš¨
            target_hex = calculate_target_hexagram(hex_num, line_pos)
            if target_hex:
                eff_change_map[hex_num][line_pos] = target_hex
    
    return eff_change_map

# ğŸ¯ ì „ì²´ íš¨ë³€ ë§µ ìƒì„± (ì „ì—­ ë³€ìˆ˜)
eff_change_map = generate_full_eff_change_map()

# ğŸ‰ 384ê°€ì§€ íš¨ë³€ ì‹œë‚˜ë¦¬ì˜¤ ì™„ì„±!
print(f"ğŸ† íš¨ë³€ ë§µ ìƒì„± ì™„ë£Œ: {len(eff_change_map)}ê´˜ Ã— 6íš¨ = {sum(len(v) for v in eff_change_map.values())}ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤")

st.set_page_config(page_title="ì£¼ì—­ ì ê´˜ ì¶”ì²œ ì‹œìŠ¤í…œ", layout="wide")
st.title("ğŸ”® ì£¼ì—­ ì ê´˜ ì¶”ì²œ ì‹œìŠ¤í…œ (í…ŒìŠ¤íŠ¸ ì¤‘)")

# ğŸ² 1. ì£¼ì‚¬ìœ„ ê²°ê³¼ ì…ë ¥
st.subheader("ğŸ² ì£¼ì‚¬ìœ„ ê²°ê³¼ ì…ë ¥")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'high_trigram' not in st.session_state:
    st.session_state.high_trigram = 1
if 'low_trigram' not in st.session_state:
    st.session_state.low_trigram = 1
if 'changing_lines' not in st.session_state:
    st.session_state.changing_lines = []

def generate_random_gua():
    st.session_state.high_trigram = random.randint(1, 8)
    st.session_state.low_trigram = random.randint(1, 8)

def generate_random_changing_lines():
    # 0ê°œ, 1ê°œ, 2ê°œ, 3ê°œ, 4ê°œ, 5ê°œ, 6ê°œ íš¨ë³€ ì¤‘ ëœë¤ ì„ íƒ
    num_changes = random.randint(0, 6)
    if num_changes == 0:
        st.session_state.changing_lines = []
    else:
        st.session_state.changing_lines = sorted(random.sample(range(1, 7), num_changes))

col_gua_input, col_gua_button = st.columns([2, 1])
with col_gua_input:
    st.write(f"í˜„ì¬ ìƒê´˜: **{st.session_state.high_trigram}**")
    st.write(f"í˜„ì¬ í•˜ê´˜: **{st.session_state.low_trigram}**")
with col_gua_button:
    st.button("ğŸ² ëœë¤ ê´˜ ë½‘ê¸°", on_click=generate_random_gua)

# ğŸ° 2. ê´˜ ë²ˆí˜¸ ê³„ì‚°
gua_number = (st.session_state.high_trigram - 1) * 8 + st.session_state.low_trigram
st.write(f"ğŸ‘‰ ì„ íƒëœ ê´˜ ë²ˆí˜¸ëŠ”: **{gua_number}ë²ˆ**")

# ğŸ”„ 3. íš¨ë³€(çˆ»è®Š) ì„ íƒ
st.subheader("ğŸ”„ íš¨ë³€ ì„ íƒ")
st.markdown("""
**íš¨ë³€ì´ë€?** ì£¼ì—­ì—ì„œ ë³€í•˜ëŠ” íš¨(çˆ»)ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤. ê° ê´˜ëŠ” 6ê°œì˜ íš¨ë¡œ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°,  
íš¨ê°€ ë³€í•˜ë©´ ë‹¤ë¥¸ ê´˜ë¡œ ë³€í™”í•©ë‹ˆë‹¤. ë³€í•˜ëŠ” íš¨ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ê´˜ì˜ ì˜ë¯¸ë§Œ í•´ì„í•©ë‹ˆë‹¤.
""")

col_line_input, col_line_button = st.columns([2, 1])
with col_line_input:
    if st.session_state.changing_lines:
        st.write(f"ğŸ”„ ë³€í•˜ëŠ” íš¨: **{', '.join(map(str, st.session_state.changing_lines))}íš¨**")
        st.write(f"ğŸ“Š ë³€íš¨ ê°œìˆ˜: **{len(st.session_state.changing_lines)}ê°œ**")
    else:
        st.write("ğŸ“ ë³€íš¨ ì—†ìŒ: ë³¸ê´˜ ì¤‘ì‹¬ í•´ì„")
with col_line_button:
    st.button("âœ¨ ëœë¤ íš¨ë³€ ì„ íƒ", on_click=generate_random_changing_lines)

# ğŸ¨ 4. ê´˜ìƒ ì‹œê°í™”
st.subheader("ğŸ¨ ê´˜ìƒ ì‹œê°í™”")
# 8ê´˜ ê¸°ë³¸ ìƒì§• ë§¤í•‘
trigram_symbols = {
    1: ("â˜°", "ê±´(ä¹¾)", "í•˜ëŠ˜"),
    2: ("â˜±", "íƒœ(å…Œ)", "ì—°ëª»"),
    3: ("â˜²", "ì´(é›¢)", "ë¶ˆ"),
    4: ("â˜³", "ì§„(éœ‡)", "ì²œë‘¥"),
    5: ("â˜´", "ì†(å·½)", "ë°”ëŒ"),
    6: ("â˜µ", "ê°(å)", "ë¬¼"),
    7: ("â˜¶", "ê°„(è‰®)", "ì‚°"),
    8: ("â˜·", "ê³¤(å¤)", "ë•…")
}

# ìƒê´˜ì™€ í•˜ê´˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
high_symbol, high_name, high_meaning = trigram_symbols[st.session_state.high_trigram]
low_symbol, low_name, low_meaning = trigram_symbols[st.session_state.low_trigram]

# 3ì—´ ë ˆì´ì•„ì›ƒìœ¼ë¡œ ê´˜ìƒ í‘œì‹œ
col1, col2, col3 = st.columns([1, 2, 1])

with col2:
    st.markdown(f"""
    <div style="text-align: center; font-size: 24px; line-height: 1.5;">
        <div style="font-size: 48px; margin-bottom: 10px;">{high_symbol}</div>
        <div style="font-size: 24px; color: #666;"><strong>ìƒê´˜</strong>: {high_name} ({high_meaning})</div>
        <div style="margin: 20px 0; font-size: 20px;">+</div>
        <div style="font-size: 48px; margin-bottom: 10px;">{low_symbol}</div>
        <div style="font-size: 24px; color: #666;"><strong>í•˜ê´˜</strong>: {low_name} ({low_meaning})</div>
        <div style="margin: 20px 0; font-size: 20px;">â†“</div>
        <div style="font-size: 36px; margin-bottom: 10px;">{high_symbol}{low_symbol}</div>
        <div style="font-size: 20px; color: #333; font-weight: bold;">{gua_number}ë²ˆ ê´˜</div>
    </div>
    """, unsafe_allow_html=True)

# íš¨ë³€ ì‹œê°í™” (ì„ íƒëœ ê²½ìš°)
if st.session_state.changing_lines:
    st.markdown("ğŸ”„ **ë³€í•˜ëŠ” íš¨ ìœ„ì¹˜:**")
    # 6íš¨ë¥¼ ìœ„ì—ì„œë¶€í„° ì•„ë˜ë¡œ í‘œì‹œ (6, 5, 4, 3, 2, 1)
    for line_num in [6, 5, 4, 3, 2, 1]:
        if line_num in st.session_state.changing_lines:
            st.markdown(f"**{line_num}íš¨**: â†’ ğŸ”„ **ë³€í™”** â†")
        else:
            st.markdown(f"{line_num}íš¨: â”€â”€â”€ ê³ ì •")



# ğŸ§  3. LLMì— ì „ë‹¬í•  ì§ˆë¬¸ ìƒì„±
# mongodb.pyì˜ parse_hexagram_queryê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì§ˆë¬¸ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
question_to_llm = f"{gua_number}ë²ˆê´˜ì— ëŒ€í•´ ì„¤ëª…í•´ì£¼ì„¸ìš”."

# ğŸ§¾ 5. ê²°ê³¼ ìš”ì²­
if st.button("ğŸ§­ ê´˜ í•´ì„ ë° ë‹¤ìŒ ê´˜ ì¶”ì²œë°›ê¸°"):
    st.markdown("---")
    st.subheader("ğŸ’¬ AI ì‘ë‹µ:")
    st.info("AIê°€ í˜„ì¬ ê´˜ì— ëŒ€í•œ ì‹¬ì¸µì ì¸ í•´ì„ì„ ì œê³µí•©ë‹ˆë‹¤. ì´ í•´ì„ì€ ë‹¹ì‹ ì˜ ì§ˆë¬¸ì— ëŒ€í•œ í†µì°°ì„ ì œê³µí•  ê²ƒì…ë‹ˆë‹¤.")
    with st.spinner("AIê°€ ì‘ë‹µì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."):
        try:
            # ask_hexagramì€ ì‘ë‹µ ì¡°ê°(chunk)ë“¤ì„ yieldí•˜ëŠ” ì œë„ˆë ˆì´í„°ì…ë‹ˆë‹¤.
            # st.write_streamì„ ì‚¬ìš©í•˜ì—¬ ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ í‘œì‹œí•©ë‹ˆë‹¤.
            response_stream = ask_hexagram(question_to_llm)
            st.write_stream(response_stream)
            
            # ğŸ”® 6. ë‹¤ìŒ ê´˜ ì¶”ì²œ
            st.markdown("---")
            st.subheader("ğŸ”® ë‹¤ìŒ ê´˜ ì¶”ì²œ")
            st.info("AIê°€ í˜„ì¬ ê´˜ì™€ ì—°ê²°ë  ìˆ˜ ìˆëŠ” ë‹¤ìŒ ê´˜ë“¤ì„ ì¶”ì²œí•©ë‹ˆë‹¤. ì´ ê´˜ë“¤ì€ í˜„ì¬ ìƒí™©ì˜ ë°œì „ ë°©í–¥ì´ë‚˜ ìˆ¨ê²¨ì§„ ì˜ë¯¸ë¥¼ íƒìƒ‰í•˜ëŠ” ë° ë„ì›€ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            
            # 64ê´˜ ì£¼ì œì  ì—°ê²°ì„± ë§¤í•‘ (ì™„ì „íŒ)
            gua_links = {
                # ìƒê²½ (1~30): ì²œì§€ ì›ë¦¬ì™€ ê¸°ë³¸ ë²•ì¹™
                1: [2, 44],      # ê±´(ì›ë ¥) â†’ ê³¤(ìˆ˜ìš©), êµ¬(ë§Œë‚¨)
                2: [1, 23],      # ê³¤(ìˆ˜ìš©) â†’ ê±´(ì›ë ¥), ë°•(ë¶•ê´´)
                3: [4, 20],      # ë‘¥(ì–´ë ¤ì›€) â†’ ëª½(ê³„ëª½), ê´€(ê´€ì°°)
                4: [3, 22],      # ëª½(ê³„ëª½) â†’ ë‘¥(ì–´ë ¤ì›€), ë¹„(ê¾¸ë¯¸)
                5: [6, 48],      # ìˆ˜(ê¸°ë‹¤ë¦¼) â†’ ì†¡(ë‹¤íˆ¼), ì •(ìš°ë¬¼)
                6: [5, 9, 23],   # ì†¨(ë‹¤íˆ¼) â†’ ìˆ˜(ê¸°ë‹¤ë¦¼), ì†Œì¶•(ì¶•ì ), ë°•(ë¶•ê´´)
                7: [8, 13],      # ì‚¬(êµ°ëŒ€) â†’ ë¹„(ì¹œí™”), ë™ì¸(ë™ì§€)
                8: [7, 14],      # ë¹„(ì¹œí™”) â†’ ì‚¬(êµ°ëŒ€), ëŒ€ìœ (í’ìš”)
                9: [10, 26],     # ì†Œì¶•(ì¤€ë¹„) â†’ ë¦¬(ì‹¤í–‰), ëŒ€ì¶•(í° ì €ì¶•)
                10: [9, 58],     # ë¦¬(ì˜ˆì˜) â†’ ì†Œì¶•(ì¤€ë¹„), íƒœ(ì¦ˆê±°ì›€)
                
                # ëŒ€ë¦½ê³¼ ì¡°í™”ì˜ ìˆœí™˜
                11: [12, 19],    # íƒœ(í‰ì•ˆ) â†” ë¹„(ë§‰í˜), ì„(ë‹¤ê°€ê°)
                12: [11, 20],    # ë¹„(ë§‰í˜) â†” íƒœ(í‰ì•ˆ), ê´€(ê´€ì°°)
                13: [14, 49],    # ë™ì¸(ë™ì§€) â†’ ëŒ€ìœ (í’ìš”), í˜(ë³€í˜)
                14: [13, 43],    # ëŒ€ìœ (í’ìš”) â†’ ë™ì¸(ë™ì§€), ê²°(ê²°ë‹¨)
                15: [16, 62],    # ê²¸(ê²¸ì†) â†’ ì˜ˆ(ê¸°ì¨), ì†Œê³¼(ì†Œê³¼)
                16: [15, 51],    # ì˜ˆ(ê¸°ì¨) â†’ ê²¸(ê²¸ì†), ì§„(ì¶©ê²©)
                17: [18, 45],    # ìˆ˜(ë”°ë¦„) â†’ ê³ (ë°”ë¡œì¡ê¸°), ì·¨(ëª¨ì´ê¸°)
                18: [17, 46],    # ê³ (ë°”ë¡œì¡ê¸°) â†’ ìˆ˜(ë”°ë¦„), ìŠ¹(ì˜¤ë¥´ê¸°)
                19: [20, 41],    # ì„(ë‹¤ê°€ê°) â†’ ê´€(ê´€ì°°), ì†(ëœì–´ëƒ„)
                20: [19, 42],    # ê´€(ê´€ì°°) â†’ ì„(ë‹¤ê°€ê°), ìµ(ë”í•¨)
                
                # ê²°ë‹¨ê³¼ ì•„ë¦„ë‹¤ì›€
                21: [22, 27],    # ì„œí•©(ê²°ë‹¨) â†’ ë¹„(ì¥ì‹), ì´(ê¸°ë¦„)
                22: [21, 36],    # ë¹„(ì¥ì‹) â†’ ì„œí•©(ê²°ë‹¨), ëª…ì´(ì–´ë‘˜)
                23: [24, 2],     # ë°•(ë¶•ê´´) â†’ ë³µ(íšŒë³µ), ê³¤(ìˆ˜ìš©)
                24: [25, 51],    # ë³µ(íšŒë³µ) â†’ ë¬´ë§(ì§„ì‹¤), ì§„(ì¶©ê²©)
                25: [26, 17],    # ë¬´ë§(ì§„ì‹¤) â†’ ëŒ€ì¶•(í° ì €ì¶•), ìˆ˜(ë”°ë¦„)
                26: [9, 18],     # ëŒ€ì¶•(í° ì €ì¶•) â†’ ì†Œì¶•(ì¤€ë¹„), ê³ (ë°”ë¡œì¡ê¸°)
                27: [28, 50],    # ì´(ê¸°ë¦„) â†’ ëŒ€ê³¼(ê³¼ëŒ€), ì •(ìš°ë¦¬)
                28: [27, 62],    # ëŒ€ê³¼(ê³¼ëŒ€) â†’ ì´(ê¸°ë¦„), ì†Œê³¼(ì†Œê³¼)
                29: [30, 60],    # ê°(í—˜ë‚œ) â†’ ë¦¬(ë°ìŒ), ì ˆ(ì ˆë„)
                30: [29, 56],    # ë¦¬(ë°ìŒ) â†’ ê°(í—˜ë‚œ), ë¡œ(ë‚˜ê·¸ë„¤)
                
                # í•˜ê²½ (31~64): ì¸ê°„ê´€ê³„ì™€ ì‚¬íšŒì  ìƒí™©
                31: [32, 39],    # í•¨(ê°ì‘) â†’ í•­(ì§€ì†), ê±´(ì–´ë ¤ì›€)
                32: [31, 34],    # í•­(ì§€ì†) â†’ í•¨(ê°ì‘), ëŒ€ì¥(í° ì¥)
                33: [34, 44],    # ë‘”(ë¬¼ëŸ¬ë‚¨) â†’ ëŒ€ì¥(í° ì¥), êµ¬(ë§Œë‚¨)
                34: [33, 55],    # ëŒ€ì¥(í° ì¥) â†’ ë‘”(ë¬¼ëŸ¬ë‚¨), í’(í’ì„±)
                35: [36, 64],    # ì§„(ì „ì§„) â†’ ëª…ì´(ì–´ë‘˜), ë¯¸ì œ(ë¯¸ì™„)
                36: [35, 22],    # ëª…ì´(ì–´ë‘˜) â†’ ì§„(ì „ì§„), ë¹„(ì¥ì‹)
                37: [38, 40],    # ê°€ì¸(ê°€ì¡±) â†’ ê·œ(ë”°ë¡œ) ë„ìš´, í•´(í•´ê²°)
                38: [37, 54],    # ê·œ(ë”°ë¡œ) â†’ ê°€ì¸(ê°€ì¡±), ê·€ë©”(ì‹œì§‘ê°€ê¸°)
                39: [40, 31],    # ê±´(ì–´ë ¤ì›€) â†’ í•´(í•´ê²°), í•¨(ê°ì‘)
                40: [39, 16],    # í•´(í•´ê²°) â†’ ê±´(ì–´ë ¤ì›€), ì˜ˆ(ê¸°ì¨)
                
                # ì†ìµê³¼ ë³€í™”
                41: [42, 19],    # ì†(ëœì–´ëƒ„) â†’ ìµ(ë”í•¨), ì„(ë‹¤ê°€ê°)
                42: [41, 20],    # ìµ(ë”í•¨) â†’ ì†(ëœì–´ëƒ„), ê´€(ì°°)
                43: [44, 14],    # ê²°(ê²°ë‹¨) â†’ êµ¬(ë§Œë‚¨), ëŒ€ìœ (í’ìš”)
                44: [43, 1],     # êµ¬(ë§Œë‚¨) â†’ ê²°(ê²°ë‹¨), ê±´(ì›ë ¥)
                45: [46, 17],    # ì·¨(ëª¨ì´ê¸°) â†’ ìŠ¹(ì˜¤ë¥´ê¸°), ìˆ˜(ë”°ë¦„)
                46: [45, 18],    # ìŠ¹(ì˜¤ë¥´ê¸°) â†’ ì·¨(ëª¨ì´ê¸°), ê³ (ë°”ë¡œì¡ê¸°)
                47: [48, 37],    # ê³¤(ê³¤ë€) â†’ ì •(ìš°ë¬¼), ê°€ì¸(ê°€ì¡±)
                48: [47, 5],     # ì •(ìš°ë¬¼) â†’ ê³¤(ê³¤ë€), ìˆ˜(ê¸°ë‹¤ë¦¼)
                49: [50, 13],    # í˜(ë³€í˜) â†’ ì •(ìš°ë¦¬), ë™ì¸(ë™ì§€)
                50: [49, 27],    # ì •(ìš°ë¦¬) â†’ í˜(ë³€í˜), ì´(ê¸°ë¦„)
                
                # ì¶©ê²©ê³¼ ì•ˆì •
                51: [52, 24],    # ì§„(ì¶©ê²©) â†’ ê°„(ì •ì§€), ë³µ(íšŒë³µ)
                52: [51, 15],    # ê°„(ì •ì§€) â†’ ì§„(ì¶©ê²©), ê²¸(ê²¸ì†)
                53: [54, 39],    # ì (ì ì§„) â†’ ê·€ë©”(ì‹œì§‘ê°€ê¸°), ê±´(ì–´ë ¤ì›€)
                54: [53, 38],    # ê·€ë©”(ì‹œì§‘ê°€ê¸°) â†’ ì (ì ì§„), ê·œ(ë”°ë¡œ)
                55: [56, 34],    # í’(í’ì„±) â†’ ë¡œ(ë‚˜ê·¸ë„¤), ëŒ€ì¥(í° ì¥)
                56: [55, 30],    # ë¡œ(ë‚˜ê·¸ë„¤) â†’ í’(í’ì„±), ë¦¬(ë°ìŒ)
                57: [58, 9],     # ì†(ë°”ëŒ) â†’ íƒœ(ì¦ˆê±°ì›€), ì†Œì¶•(ì¤€ë¹„)
                58: [57, 10],    # íƒœ(ì¦ˆê±°ì›€) â†’ ì†(ë°”ëŒ), ë¦¬(ì˜ˆì˜)
                59: [60, 6],     # í™˜(í™ì–´ì§) â†’ ì ˆ(ì ˆë„), ì†¡(ë‹¤íˆ¼)
                60: [59, 29],    # ì ˆ(ì ˆë„) â†’ í™˜(í™ì–´ì§), ê°(í—˜ë‚œ)
                
                # ì§„ë¦¬ì™€ ì˜ˆì˜
                61: [62, 33],    # ì¤‘ë¶€(ì§„ë¦¬) â†’ ì†Œê³¼(ì†Œê³¼), ë‘”(ë¬¼ëŸ¬ë‚¨)
                62: [61, 15],    # ì†Œê³¼(ì†Œê³¼) â†’ ì¤‘ë¶€(ì§„ë¦¬), ê²¸(ê²¸ì†)
                
                # ì™„ì„±ê³¼ ë¯¸ì™„ì„±ì˜ ìˆœí™˜
                63: [64, 1],     # ê¸°ì œ(ì™„ì„±) â†’ ë¯¸ì œ(ë¯¸ì™„), ê±´(ìƒˆ ì‹œì‘)
                64: [63, 35, 1], # ë¯¸ì œ(ë¯¸ì™„) â†’ ê¸°ì œ(ì™„ì„±), ì§„(ì „ì§„), ê±´(ìƒˆ ì‹œì‘)
            }
            
            # ğŸ‰ 384ê°€ì§€ íš¨ë³€ ì‹œë‚˜ë¦¬ì˜¤ ì™„ì„±! 
            # ì „ì²´ eff_change_mapì€ ìƒë‹¨ì—ì„œ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            # ë‹¤ìŒ ê´˜ ì¶”ì²œ ë¡œì§
            if st.session_state.changing_lines:
                st.markdown("ğŸ”„ **íš¨ë³€ ê¸°ë°˜ ì¶”ì²œ:**")
                
                if len(st.session_state.changing_lines) == 1:
                    # 1ê°œ íš¨ ë³€í™” ì‹œ ì§€ê´˜ ê³„ì‚°
                    changing_line = st.session_state.changing_lines[0]
                    if gua_number in eff_change_map and changing_line in eff_change_map[gua_number]:
                        target_gua = eff_change_map[gua_number][changing_line]
                        st.success(f"ğŸ¯ **ì§€ê´˜(ä¹‹å¦)**: {target_gua}ë²ˆ ê´˜")
                        st.write(f"ğŸ“Š **í•´ì„ ì›ì¹™**: {changing_line}íš¨ ë³€í™”ì— ë”°ë¥¸ íš¨ì‚¬(çˆ»è¾­) ì¤‘ì‹¬ í•´ì„")
                    else:
                        st.info("í•´ë‹¹ ê´˜ì˜ íš¨ë³€ ë°ì´í„°ê°€ ì•„ì§ êµ¬ì¶•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                        
                elif len(st.session_state.changing_lines) == 2:
                    st.info("ğŸ“Š **í•´ì„ ì›ì¹™**: 2ê°œ íš¨ ë³€í™” ì‹œ ìœ„ìª½ íš¨ì‚¬ ì¤‘ì‹¬ í•´ì„")
                    upper_line = max(st.session_state.changing_lines)
                    st.write(f"ğŸ”¼ **ì£¼ìš” íš¨**: {upper_line}íš¨")
                    
                elif len(st.session_state.changing_lines) == 3:
                    st.info("ğŸ“Š **í•´ì„ ì›ì¹™**: 3ê°œ íš¨ ë³€í™” ì‹œ ë³¸ê´˜+ì§€ê´˜ ì¢…í•© í•´ì„")
                    
                else:
                    st.info(f"ğŸ“Š **í•´ì„ ì›ì¹™**: {len(st.session_state.changing_lines)}ê°œ íš¨ ë³€í™” ì‹œ ì§€ê´˜ ì¤‘ì‹¬ í•´ì„")
                    
            else:
                st.markdown("ğŸ”— **ì£¼ì œì  ì—°ê²° ì¶”ì²œ:**")
                if gua_number in gua_links:
                    linked_guas = gua_links[gua_number]
                    
                    # ìœ ì‚¬ì„± ìˆëŠ” 3ê°€ì§€ ì„ íƒì§€ ì œê³µ
                    num_options = min(3, len(linked_guas))
                    if num_options > 0:
                        selected_options = random.sample(linked_guas, num_options)
                        
                        st.write("ë‹¤ìŒ ê´˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ë” ê¹Šì´ íƒêµ¬í•´ë³´ì„¸ìš”:")
                        selected_next_gua = st.selectbox(
                            "ì„ íƒì§€",
                            options=selected_options,
                            format_func=lambda x: f"{x}ë²ˆ ê´˜"
                        )
                        st.success(f"ğŸ¯ **ì„ íƒëœ ë‹¤ìŒ ê´˜**: {selected_next_gua}ë²ˆ ê´˜")
                        st.write(f"â€¢ {selected_next_gua}ë²ˆ ê´˜: ì² í•™ì  ì—°ê²°ì„±ì— ë”°ë¥¸ ìì—°ìŠ¤ëŸ¬ìš´ íë¦„")
                    else:
                        st.info("í•´ë‹¹ ê´˜ì˜ ì£¼ì œì  ì—°ê²° ë°ì´í„°ê°€ ì•„ì§ êµ¬ì¶•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                else:
                    st.info("í•´ë‹¹ ê´˜ì˜ ì£¼ì œì  ì—°ê²° ë°ì´í„°ê°€ ì•„ì§ êµ¬ì¶•ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
                    
            # ë°©ë²•ë¡  ì„¤ëª…
            with st.expander("ğŸ“š ì£¼ì—­ ì ì‚¬ë²• ì›ì¹™ ë³´ê¸°"):
                st.markdown("""
                **ë³€íš¨ ìˆ˜ë³„ í•´ì„ ì›ì¹™:**
                - **0ê°œ**: ë³¸ê´˜ ê´˜ì‚¬(å¦è¾­)ë¡œ í•´ì„
                - **1ê°œ**: í•´ë‹¹ íš¨ì‚¬(çˆ»è¾­)ë¡œ í•´ì„
                - **2ê°œ**: ìœ„ìª½ íš¨ì‚¬ë¡œ í•´ì„
                - **3ê°œ**: ë³¸ê´˜ì™€ ì§€ê´˜ ì¢…í•© í•´ì„
                - **4~6ê°œ**: ì§€ê´˜ ì¤‘ì‹¬ í•´ì„
                
                **ê´˜ìŒ ê´€ê³„:**
                ì£¼ì—­ì˜ 64ê´˜ëŠ” ì„œë¡œ ì² í•™ì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©°,  
                í˜„ì¬ ìƒí™©ì—ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ì „ê°œë  ìˆ˜ ìˆëŠ” ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì•ˆë‚´í•©ë‹ˆë‹¤.
                """)
            
        except Exception as e:
            logging.error(f"ask_hexagram í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
            st.info("Ollama ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ê³ , mongodb.pyì— ì„¤ì •ëœ ëª¨ë¸('exaone3.5:7.8b')ì´ Ollamaì— ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.")
    
    st.markdown("---")
    st.subheader("âœ¨ ë‹¤ìŒ ë‹¨ê³„:")
    st.markdown("""
    - **ìƒˆë¡œìš´ ê´˜ ë½‘ê¸°**: ìƒë‹¨ì˜ 'ëœë¤ ê´˜ ë½‘ê¸°' ë˜ëŠ” 'ëœë¤ íš¨ë³€ ì„ íƒ' ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆë¡œìš´ ì ê´˜ë¥¼ ë½‘ì•„ë³´ì„¸ìš”.
    - **ì‹¬ì¸µ íƒêµ¬**: ì¶”ì²œëœ ë‹¤ìŒ ê´˜ ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í•´ë‹¹ ê´˜ì— ëŒ€í•´ ë” ê¹Šì´ íƒêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    - **í”¼ë“œë°± ì œê³µ**: ì‹œìŠ¤í…œ ê°œì„ ì„ ìœ„í•œ ì˜ê²¬ì´ ìˆë‹¤ë©´ ì–¸ì œë“ ì§€ ì•Œë ¤ì£¼ì„¸ìš”!
    """)

